<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>FTC Scouting Dashboard</title>
  <style>
    body {
      font-family: "Segoe UI", sans-serif;
      margin: 0;
      padding: 0;
      background: #f0f4f8;
      color: #333;
    }
    header {
      background: #2563eb;
      color: white;
      padding: 20px;
      text-align: center;
      font-size: 24px;
      font-weight: bold;
      box-shadow: 0 2px 6px rgba(0,0,0,0.15);
    }
    main {
      max-width: 1100px;
      margin: 30px auto;
      padding: 0 20px;
    }
    .box {
      background: white;
      padding: 20px;
      margin-bottom: 25px;
      border-radius: 10px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.08);
      transition: transform 0.2s ease;
    }
    .box:hover {
      transform: translateY(-3px);
    }
    h2 {
      margin-top: 0;
      color: #2563eb;
      font-size: 20px;
      border-bottom: 2px solid #e5e7eb;
      padding-bottom: 8px;
    }
    input, select, textarea, button {
      width: 100%;
      margin-top: 10px;
      padding: 10px;
      font-size: 15px;
      border: 1px solid #d1d5db;
      border-radius: 6px;
      box-sizing: border-box;
    }
    input:focus, select:focus, textarea:focus {
      outline: none;
      border-color: #2563eb;
      box-shadow: 0 0 5px rgba(37,99,235,0.3);
    }
    textarea {
      height: 90px;
      resize: vertical;
    }
    button {
      background: #2563eb;
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-weight: bold;
      margin-top: 14px;
      transition: background 0.3s ease;
    }
    button:hover {
      background: #1e40af;
    }
    .result-card {
      background: #ffffff;
      border-radius: 8px;
      padding: 16px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.08);
      margin-top: 12px;
    }
    .match-list {
      margin-top: 10px;
    }
    .match-item {
      border: 1px solid #e5e7eb;
      border-radius: 8px;
      padding: 10px;
      margin-bottom: 10px;
      background: #f9fafb;
    }
    .match-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      cursor: pointer;
    }
    .match-title {
      font-weight: bold;
      color: #111827;
    }
    .team-tags {
      margin-top: 8px;
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
    }
    .team-tag {
      background: #e5f0ff;
      color: #1d4ed8;
      padding: 4px 8px;
      border-radius: 999px;
      font-size: 13px;
      cursor: pointer;
    }
    .team-tag.red {
      background: #fee2e2;
      color: #b91c1c;
    }
    .team-tag.blue {
      background: #dbeafe;
      color: #1d4ed8;
    }
    .flex-row {
      display: flex;
      gap: 20px;
      flex-wrap: wrap;
    }
    .flex-col {
      flex: 1 1 300px;
    }
    .label {
      font-size: 13px;
      color: #6b7280;
      margin-top: 8px;
    }
    .small-input {
      width: 100%;
    }
    .section-title {
      font-weight: bold;
      margin-top: 10px;
      color: #111827;
    }
  </style>
</head>
<body>

<header>FTC Scouting Dashboard</header>

<main>
  <div class="box">
    <h2>üì° Sync Competition</h2>
    <input id="eventCode" placeholder="Enter Event Code (e.g. NYQNY)" />
    <button id="btnSync">Sync Event</button>
    <div id="eventSummary"></div>
  </div>

  <div class="box">
    <h2>üìÖ Matches & Teams</h2>
    <div id="matchesContainer">
      <p>Sync an event to load matches.</p>
    </div>
  </div>

  <div class="box">
    <h2>üìù Edit Report for Selected Team</h2>
    <div id="currentContext" style="margin-bottom:8px; font-size:14px; color:#4b5563;">
      No match/team selected.
    </div>
    <div class="flex-row">
      <div class="flex-col">
        <div class="label">Match Date</div>
        <input id="report_match_date" type="date" class="small-input" />

        <div class="label">Shooting Range</div>
        <select id="report_shooting_range" class="small-input">
          <option value="">Select Shooting Range</option>
          <option value="near">Near</option>
          <option value="far">Far</option>
          <option value="mostly near">Mostly Near</option>
          <option value="mostly far">Mostly Far</option>
          <option value="varies">Varies</option>
        </select>

        <div class="label">Robots Scored</div>
        <input id="report_robots_scored" type="number" class="small-input" />

        <div class="label">Max Score Without Pattern</div>
        <input id="report_max_score_without_pattern" class="small-input" />

        <div class="label">Max Score With Pattern</div>
        <input id="report_max_score_with_pattern" class="small-input" />
      </div>

      <div class="flex-col">
        <div class="label">Needs Human Player?</div>
        <select id="report_needs_human_player" class="small-input">
          <option value="">Select</option>
          <option value="yes">Yes</option>
          <option value="no">No</option>
        </select>

        <div class="label">Has Lifting for Parking?</div>
        <select id="report_has_lifting_for_parking" class="small-input">
          <option value="">Select</option>
          <option value="yes">Yes</option>
          <option value="no">No</option>
        </select>

        <div class="label">Notes</div>
        <textarea id="report_notes" class="small-input" placeholder="Observations, strengths, weaknesses..."></textarea>

        <button id="btnSaveReport">Save Report</button>
      </div>
    </div>
  </div>

  <div class="box">
    <h2>üìä Reports for a Team</h2>
    <input id="search_team_number" placeholder="Enter Team Number" />
    <button id="btnLoadTeamReports">Load Reports</button>
    <div id="teamReportsContainer"></div>
  </div>
</main>

<script>
const API = "http://localhost:8000"; // adjust if needed

const elEventCode = document.getElementById("eventCode");
const elBtnSync = document.getElementById("btnSync");
const elEventSummary = document.getElementById("eventSummary");
const elMatchesContainer = document.getElementById("matchesContainer");

const elCurrentContext = document.getElementById("currentContext");
const elReportDate = document.getElementById("report_match_date");
const elReportShooting = document.getElementById("report_shooting_range");
const elReportRobots = document.getElementById("report_robots_scored");
const elReportMaxNoPattern = document.getElementById("report_max_score_without_pattern");
const elReportMaxPattern = document.getElementById("report_max_score_with_pattern");
const elReportNeedsHP = document.getElementById("report_needs_human_player");
const elReportHasLift = document.getElementById("report_has_lifting_for_parking");
const elReportNotes = document.getElementById("report_notes");
const elBtnSaveReport = document.getElementById("btnSaveReport");

const elSearchTeamNumber = document.getElementById("search_team_number");
const elBtnLoadTeamReports = document.getElementById("btnLoadTeamReports");
const elTeamReportsContainer = document.getElementById("teamReportsContainer");

let currentMatchId = null;
let currentTeamNumber = null;

// Helpers
function formatDateInputValue(isoDate) {
  if (!isoDate) return "";
  const d = new Date(isoDate);
  const year = d.getFullYear();
  const month = String(d.getMonth() + 1).padStart(2, "0");
  const day = String(d.getDate()).padStart(2, "0");
  return `${year}-${month}-${day}`;
}

// Sync event
elBtnSync.addEventListener("click", async () => {
  const code = elEventCode.value.trim();
  if (!code) {
    alert("Enter an event code");
    return;
  }

  elEventSummary.innerHTML = "<p>Syncing...</p>";
  elMatchesContainer.innerHTML = "<p>Loading matches...</p>";

  try {
    const res = await fetch(`${API}/sync/event/${encodeURIComponent(code)}`, { method: "POST" });
    if (!res.ok) {
      const detail = await res.json().catch(() => ({}));
      throw new Error(detail.detail || `Sync failed with ${res.status}`);
    }
    const summaryRes = await fetch(`${API}/sync/event/${encodeURIComponent(code)}/summary`);
    const summary = await summaryRes.json();

    elEventSummary.innerHTML = `
      <div class="result-card">
        <h3>Event Summary</h3>
        <p><strong>Event Code:</strong> ${summary.event_code}</p>
        <p><strong>Season:</strong> ${summary.season}</p>
        <p><strong>Teams:</strong> ${summary.teams}</p>
        <p><strong>Matches:</strong> ${summary.matches}</p>
      </div>
    `;

    await loadMatchesForEvent(code);
  } catch (err) {
    console.error(err);
    elEventSummary.innerHTML = `<p style="color:red;">${err.message}</p>`;
    elMatchesContainer.innerHTML = `<p style="color:red;">Failed to load matches.</p>`;
  }
});

// Load matches for event
async function loadMatchesForEvent(eventCode) {
  const res = await fetch(`${API}/matches/event/${encodeURIComponent(eventCode)}`);
  if (!res.ok) {
    elMatchesContainer.innerHTML = `<p style="color:red;">Failed to load matches</p>`;
    return;
  }
  const matches = await res.json();
  if (!matches.length) {
    elMatchesContainer.innerHTML = "<p>No matches found for this event.</p>";
    return;
  }

  let html = '<div class="match-list">';
  for (const m of matches) {
    const start = m.start_time ? new Date(m.start_time).toLocaleString() : "-";
    const redTeams = [];
    const blueTeams = [];
    for (const p of m.participations) {
      const label = `#${p.team.team_number}`;
      if (p.alliance === "red") redTeams.push(label);
      else if (p.alliance === "blue") blueTeams.push(label);
    }

    html += `
      <div class="match-item">
        <div class="match-header" onclick="toggleMatchDetails('${m.id}')">
          <div class="match-title">${m.match_type || ""} ${m.match_number || ""} (${m.match_key})</div>
          <div style="font-size:13px; color:#6b7280;">${start}</div>
        </div>
        <div id="match-details-${m.id}" style="display:none; margin-top:8px;">
          <div class="section-title">Teams</div>
          <div class="team-tags">
    `;

    for (const p of m.participations) {
      const cls = p.alliance === "red" ? "team-tag red" : "team-tag blue";
      html += `
        <div class="${cls}" onclick="selectMatchTeam(event, ${m.id}, ${p.team.team_number}, '${m.match_type || ""}', ${m.match_number || "null"})">
          ${p.alliance?.toUpperCase() || ""} ${p.station || ""} - #${p.team.team_number}
        </div>
      `;
    }

    html += `
          </div>
        </div>
      </div>
    `;
  }
  html += "</div>";

  elMatchesContainer.innerHTML = html;
}

// Expose functions to global for inline onclick
window.toggleMatchDetails = function (matchId) {
  const el = document.getElementById(`match-details-${matchId}`);
  if (!el) return;
  el.style.display = el.style.display === "none" ? "block" : "none";
};

window.selectMatchTeam = async function (ev, matchId, teamNumber, matchType, matchNumber) {
  ev.stopPropagation();
  currentMatchId = matchId;
  currentTeamNumber = teamNumber;

  elCurrentContext.textContent = `Editing report for Match ID ${matchId} (${matchType || ""} ${matchNumber || ""}), Team #${teamNumber}`;

  // Clear form first
  elReportDate.value = "";
  elReportShooting.value = "";
  elReportRobots.value = "";
  elReportMaxNoPattern.value = "";
  elReportMaxPattern.value = "";
  elReportNeedsHP.value = "";
  elReportHasLift.value = "";
  elReportNotes.value = "";

  // Try load existing
  try {
    const res = await fetch(`${API}/reports/matches/${matchId}/teams/${teamNumber}`);
    if (!res.ok) {
      return; // no existing report
    }
    const data = await res.json();
    if (data.match_date) {
      elReportDate.value = data.match_date;
    }
    elReportShooting.value = data.shooting_range || "";
    elReportRobots.value = data.robots_scored ?? "";
    elReportMaxNoPattern.value = data.max_score_without_pattern || "";
    elReportMaxPattern.value = data.max_score_with_pattern || "";
    elReportNeedsHP.value = data.needs_human_player || "";
    elReportHasLift.value = data.has_lifting_for_parking || "";
    elReportNotes.value = data.notes || "";
  } catch (err) {
    console.error("Failed to load existing report", err);
  }
};

// Save report
elBtnSaveReport.addEventListener("click", async () => {
  if (!currentMatchId || !currentTeamNumber) {
    alert("Select a match and team first.");
    return;
  }
  const payload = {
    match_date: elReportDate.value || null,
    shooting_range: elReportShooting.value || null,
    robots_scored: elReportRobots.value ? parseInt(elReportRobots.value, 10) : null,
    max_score_without_pattern: elReportMaxNoPattern.value || null,
    max_score_with_pattern: elReportMaxPattern.value || null,
    needs_human_player: elReportNeedsHP.value || null,
    has_lifting_for_parking: elReportHasLift.value || null,
    notes: elReportNotes.value || null,
  };

  try {
    const res = await fetch(`${API}/reports/matches/${currentMatchId}/teams/${currentTeamNumber}`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(payload),
    });
    if (!res.ok) {
      const detail = await res.json().catch(() => ({}));
      throw new Error(detail.detail || `Save failed with ${res.status}`);
    }
    alert("Report saved");
  } catch (err) {
    alert(`Failed to save report: ${err.message}`);
  }
});

// Load reports for a team
elBtnLoadTeamReports.addEventListener("click", async () => {
  const team = elSearchTeamNumber.value.trim();
  if (!team) {
    alert("Enter a team number");
    return;
  }
  try {
    const res = await fetch(`${API}/reports/teams/${team}`);
    if (!res.ok) {
      const detail = await res.json().catch(() => ({}));
      throw new Error(detail.detail || `Failed with ${res.status}`);
    }
    const list = await res.json();
    if (!list.length) {
      elTeamReportsContainer.innerHTML = "<p>No reports for this team yet.</p>";
      return;
    }
    let html = "";
    for (const r of list) {
      html += `
        <div class="result-card">
          <div><strong>Match ID:</strong> ${r.match_id}</div>
          <div><strong>Match Number:</strong> ${r.match_number ?? "-"}</div>
          <div><strong>Date:</strong> ${r.match_date ?? "-"}</div>
          <div><strong>Shooting Range:</strong> ${r.shooting_range ?? "-"}</div>
          <div><strong>Robots Scored:</strong> ${r.robots_scored ?? "-"}</div>
          <div><strong>Needs HP:</strong> ${r.needs_human_player ?? "-"}</div>
          <div><strong>Has Lift:</strong> ${r.has_lifting_for_parking ?? "-"}</div>
          <div><strong>Notes:</strong> ${r.notes ?? "-"}</div>
        </div>
      `;
    }
    elTeamReportsContainer.innerHTML = html;
  } catch (err) {
    elTeamReportsContainer.innerHTML = `<p style="color:red;">${err.message}</p>`;
  }
});
</script>

</body>
</html>
